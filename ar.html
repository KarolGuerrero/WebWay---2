<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>AR Wayfinding - WebWay</title>
  <link rel="icon"
    href="https://www.usergioarboleda.edu.co/wp-content/uploads/2021/05/cropped-favicon-usa-32x32.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      font-family: Arial, sans-serif;
    }

    #camera-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1;
    }

    #camera-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #threejs-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 2;
      pointer-events: none;
    }

    canvas {
      display: block;
    }

    .info-panel {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 15px 20px;
      border-radius: 15px;
      z-index: 3;
      max-width: 90%;
      text-align: center;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn {
      padding: 12px 24px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      margin: 8px 5px;
      cursor: pointer;
      font-size: 16px;
      pointer-events: auto;
    }

    .btn-secondary {
      background: #666;
    }

    .debug-info {
      font-size: 12px;
      color: #ccc;
      margin-top: 10px;
      line-height: 1.4;
    }

    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #333;
      border-top: 5px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .compass-overlay {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3;
      font-weight: bold;
    }

    .gps-quality {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 12px;
      border-radius: 10px;
      z-index: 3;
      font-size: 12px;
    }

    .quality-excellent {
      color: #4CAF50;
    }

    .quality-good {
      color: #8BC34A;
    }

    .quality-fair {
      color: #FF9800;
    }

    .quality-poor {
      color: #F44336;
    }
  </style>
</head>

<body>
  <div id="camera-container">
    <video id="camera-video" autoplay playsinline></video>
  </div>

  <div id="threejs-container"></div>

  <div class="gps-quality">
    <div id="gps-quality-text">GPS: --</div>
  </div>

  <div class="compass-overlay">
    <span id="compass-direction">N</span>
  </div>

  <div class="info-panel">
    <h3 style="margin: 0 0 10px 0;">Navegaci√≥n por Orientaci√≥n</h3>
    <p id="status-text">Inicializando...</p>
    <div id="debug" class="debug-info"></div>
    <button class="btn" onclick="window.location.href='index.html'">Volver</button>
    <button class="btn btn-secondary" id="calibrate-btn">Calibrar Br√∫jula</button>
  </div>

  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>Inicializando sensores...</p>
  </div>

  <div id="help-floating-btn" class="help-btn">?</div>

  <div id="help-modal" class="help-modal">
    <div class="help-content">
      <span class="close-help">&times;</span>

      <div class="carousel-container">

        <div class="slide active">
          <div class="slide-icon">üì±</div>
          <h3>Modo Realidad Aumentada</h3>
          <p>Est√°s viendo el campus a trav√©s de tu c√°mara.</p>
          <p>Busca la <strong>Flecha Flotante</strong> en la pantalla, ella te guiar√°.</p>
        </div>

        <div class="slide">
          <div class="slide-icon">üß≠</div>
          <h3>La Br√∫jula es Clave</h3>
          <p>Si la flecha apunta mal, tu br√∫jula necesita ajuste.</p>
          <p>Mueve tu celular haciendo la forma de un <strong>"8"</strong> en el aire varias veces.</p>
        </div>

        <div class="slide">
          <div class="slide-icon">üìç</div>
          <h3>¬øC√≥mo llego?</h3>
          <p>Sigue la direcci√≥n de la flecha.</p>
          <p>Abajo ver√°s la distancia restante. Cuando est√©s cerca (menos de 15m), te avisaremos.</p>
        </div>

        <div class="carousel-controls">
          <button id="prevBtn" class="nav-btn">‚ùÆ Anterior</button>
          <div class="dots-container" id="dotsContainer"></div>
          <button id="nextBtn" class="nav-btn">Siguiente ‚ùØ</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Estilos del M√≥dulo de Ayuda */
    .help-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      background: #FFC107;
      /* Amarillo Sergio */
      color: #003B7A;
      /* Azul Sergio */
      border-radius: 50%;
      text-align: center;
      line-height: 60px;
      font-size: 30px;
      font-weight: 800;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      cursor: pointer;
      z-index: 9999;
      /* Muy alto para estar sobre la c√°mara */
      transition: all 0.3s ease;
      border: 3px solid white;
      font-family: Arial, sans-serif;
    }

    .help-btn:hover {
      transform: scale(1.1);
    }

    .help-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      /* M√°s alto que el bot√≥n */
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 59, 122, 0.9);
      backdrop-filter: blur(5px);
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }

    .help-content {
      background-color: white;
      padding: 40px 30px;
      border-radius: 20px;
      width: 85%;
      max-width: 400px;
      position: relative;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border-top: 6px solid #FFC107;
      font-family: Arial, sans-serif;
    }

    .close-help {
      position: absolute;
      top: 15px;
      right: 20px;
      color: #ccc;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }

    .slide {
      display: none;
      flex-direction: column;
      align-items: center;
      min-height: 250px;
    }

    .slide.active {
      display: flex;
      animation: slideIn 0.4s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .slide-icon {
      font-size: 50px;
      margin-bottom: 20px;
      background: #FFF9E6;
      width: 90px;
      height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .slide h3 {
      color: #003B7A;
      margin-bottom: 15px;
      font-weight: 800;
    }

    .slide p {
      color: #555;
      line-height: 1.5;
      font-size: 16px;
    }

    .carousel-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }

    .nav-btn {
      background: none;
      border: none;
      color: #003B7A;
      cursor: pointer;
      font-weight: 700;
      font-size: 15px;
    }

    .nav-btn:disabled {
      opacity: 0.3;
    }

    .dots-container {
      display: flex;
      gap: 6px;
    }

    .dot {
      height: 8px;
      width: 8px;
      background-color: #ddd;
      border-radius: 50%;
    }

    .dot.active {
      background-color: #FFC107;
      width: 12px;
      height: 12px;
    }
  </style>

  <script>
    // L√≥gica independiente para el M√≥dulo de Ayuda
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById("help-modal");
      const btn = document.getElementById("help-floating-btn");
      const closeSpan = document.querySelector(".close-help");
      const slides = document.querySelectorAll('.slide');
      const dotsContainer = document.getElementById('dotsContainer');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');

      let currentSlide = 0;

      // Crear dots
      if (slides.length > 0 && dotsContainer.children.length === 0) {
        slides.forEach((_, idx) => {
          const dot = document.createElement('span');
          dot.classList.add('dot');
          if (idx === 0) dot.classList.add('active');
          dotsContainer.appendChild(dot);
        });
      }
      const dots = document.querySelectorAll('.dot');

      function showSlide(n) {
        slides.forEach(s => s.classList.remove('active'));
        dots.forEach(d => d.classList.remove('active'));

        currentSlide = n;

        if (slides[currentSlide]) slides[currentSlide].classList.add('active');
        if (dots[currentSlide]) dots[currentSlide].classList.add('active');

        if (prevBtn) prevBtn.disabled = currentSlide === 0;
        if (nextBtn) nextBtn.innerHTML = currentSlide === slides.length - 1 ? "¬°Entendido! üëç" : "Siguiente ‚ùØ";
      }

      if (btn) btn.onclick = () => modal.style.display = "flex";
      if (closeSpan) closeSpan.onclick = () => modal.style.display = "none";
      window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; }

      if (prevBtn) prevBtn.onclick = () => { if (currentSlide > 0) showSlide(currentSlide - 1); }
      if (nextBtn) nextBtn.onclick = () => {
        if (currentSlide < slides.length - 1) {
          showSlide(currentSlide + 1);
        } else {
          modal.style.display = "none";
          setTimeout(() => showSlide(0), 500);
        }
      }
    });
  </script>

  <script src="scripts/api.js"></script>

  <script type="module">
    import { populateUiAndReturnPoisForAR } from './scripts/app.js';
    import { requestOrientationPermissionIfNeeded, installDeviceOrientationListener, getCurrentHeading } from './scripts/orientation.js';

    // Verificar sesi√≥n activa
    if (!window.arAPI || !window.arAPI.restoreSession()) {
      alert('No hay sesi√≥n activa. Redirigiendo...');
      window.location.href = 'index.html';
    }

    class KalmanFilter {
      constructor(processNoise = 0.001, measurementNoise = 0.5) {
        this.q = processNoise;
        this.r = measurementNoise;
        this.p = 1.0;
        this.x = null;
        this.k = 0;
      }

      filter(measurement, measurementError = null) {
        if (this.x === null) {
          this.x = measurement;
          return measurement;
        }

        const r = measurementError !== null ? measurementError : this.r;
        this.p = this.p + this.q;
        this.k = this.p / (this.p + r);
        this.x = this.x + this.k * (measurement - this.x);
        this.p = (1 - this.k) * this.p;

        return this.x;
      }
    }

    class GPSPositionFilter {
      constructor() {
        this.latFilter = new KalmanFilter(0.0001, 1.0);
        this.lonFilter = new KalmanFilter(0.0001, 1.0);
        this.positions = [];
        this.maxPositions = 5;
      }

      addPosition(lat, lon, accuracy) {
        const normalizedError = Math.min(accuracy / 10, 10);

        const filteredLat = this.latFilter.filter(lat, normalizedError);
        const filteredLon = this.lonFilter.filter(lon, normalizedError);

        this.positions.push({ lat: filteredLat, lon: filteredLon, accuracy, timestamp: Date.now() });
        if (this.positions.length > this.maxPositions) {
          this.positions.shift();
        }

        return { lat: filteredLat, lon: filteredLon };
      }

      getSmoothedPosition() {
        if (this.positions.length === 0) return null;

        let totalWeight = 0;
        let weightedLat = 0;
        let weightedLon = 0;

        this.positions.forEach(pos => {
          const weight = 1 / (pos.accuracy + 1);
          weightedLat += pos.lat * weight;
          weightedLon += pos.lon * weight;
          totalWeight += weight;
        });

        return {
          lat: weightedLat / totalWeight,
          lon: weightedLon / totalWeight
        };
      }
    }

    class OrientationAR {
      constructor() {
        this.scene = null;
        this.camera = null;
        this.renderer = null;
        this.arrow = null;

        this.destino = null;
        this.userPosition = null;
        this.watchId = null;

        this.gpsFilter = new GPSPositionFilter();

        this.currentHeading = 0;
        this.targetBearing = 0;
        this.currentDistance = 0;

        this.infoDiv = null;
        this.debugDiv = null;
        this.statusText = null;
        this.compassDirection = null;
        this.gpsQualityText = null;

        // Tracking de navegaci√≥n
        this.navigationStartTime = null;
        this.navigationStartPosition = null;
        this.totalDistanceTraveled = 0;
        this.lastPosition = null;
        this.navigationActive = false;

        this.init();
      }

      async init() {
        try {
          console.log('Iniciando Navegaci√≥n por Orientaci√≥n...');

          await this.cargarDestino();
          this.configurarElementosDOM();

          this.inicializarThreeJS();

          await this.iniciarCamara();
          this.iniciarGPS();
          await this.iniciarOrientacion();

          this.animate();

          document.getElementById('loading').style.display = 'none';

        } catch (error) {
          console.error('Error:', error);
          this.mostrarError('Error: ' + error.message);
        }
      }

      // M√âTODOS DE TRACKING

      startNavigationTracking(userLat, userLon) {
        this.navigationStartTime = Date.now();
        this.navigationStartPosition = { lat: userLat, lon: userLon };
        this.lastPosition = { lat: userLat, lon: userLon };
        this.totalDistanceTraveled = 0;
        this.navigationActive = true;
        console.log('üìç Tracking iniciado:', {
          poi: this.destino.name,
          start: this.navigationStartPosition
        });
      }

      updateNavigationDistance(userLat, userLon) {
        if (this.lastPosition && this.navigationActive) {
          const segmentDist = this.calcularDistancia(
            this.lastPosition.lat,
            this.lastPosition.lon,
            this.lastPosition.lat, // ERROR FIX: Usaba userLat aqu√≠
            this.lastPosition.lon  // ERROR FIX: y aqu√≠
          );
          // Nota: Arriba hay un peque√±o bug en tu c√≥digo original,
          // deberia ser (this.lastPosition.lat, this.lastPosition.lon, userLat, userLon)
          // Lo corrijo aqu√≠ abajo:
          const realSegmentDist = this.calcularDistancia(
            this.lastPosition.lat,
            this.lastPosition.lon,
            userLat,
            userLon
          );

          if (realSegmentDist < 50) {
            this.totalDistanceTraveled += realSegmentDist;
          }
        }
        this.lastPosition = { lat: userLat, lon: userLon };
      }

      async completeNavigationTracking(arrived = true) {
        if (!this.navigationStartTime || !this.navigationStartPosition || !this.navigationActive) {
          return;
        }

        this.navigationActive = false;
        const durationSeconds = Math.floor((Date.now() - this.navigationStartTime) / 1000);

        if (window.arAPI && window.arAPI.hasActiveSession()) {
          await window.arAPI.registerNavigation(this.destino.id, {
            originLat: this.navigationStartPosition.lat,
            originLon: this.navigationStartPosition.lon,
            duration: durationSeconds,
            distance: Math.round(this.totalDistanceTraveled),
            completed: arrived
          });

          console.log('‚úÖ Navegaci√≥n registrada:', {
            poi: this.destino.name,
            duration: durationSeconds + 's',
            distance: Math.round(this.totalDistanceTraveled) + 'm',
            completed: arrived
          });
        }

        this.navigationStartTime = null;
        this.navigationStartPosition = null;
        this.totalDistanceTraveled = 0;
        this.lastPosition = null;
      }

      async cargarDestino() {
        try {
          const pois = await populateUiAndReturnPoisForAR();
          const urlParams = new URLSearchParams(window.location.search);
          const destId = urlParams.has('dest') ? parseInt(urlParams.get('dest')) : null;

          if (destId !== null) {
            this.destino = pois.find(p => p.id === destId);
            if (this.destino) {
              console.log('Destino:', this.destino);
              this.actualizarEstado(`<b>${this.destino.name}</b><br>Iniciando sensores...`);
            } else {
              throw new Error('Destino no encontrado');
            }
          } else {
            throw new Error('No se especific√≥ destino');
          }
        } catch (error) {
          throw new Error('Error cargando destino: ' + error.message);
        }
      }

      configurarElementosDOM() {
        this.infoDiv = document.querySelector('.info-panel');
        this.debugDiv = document.getElementById('debug');
        this.statusText = document.getElementById('status-text');
        this.compassDirection = document.getElementById('compass-direction');
        this.gpsQualityText = document.getElementById('gps-quality-text');

        document.getElementById('calibrate-btn').addEventListener('click', () => {
          this.calibrarBrujula();
        });
      }

      inicializarThreeJS() {
        this.scene = new THREE.Scene();
        this.scene.background = null;

        this.camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
        this.camera.position.set(0, 0, 5);

        this.renderer = new THREE.WebGLRenderer({
          alpha: true,
          antialias: true,
          powerPreference: "high-performance"
        });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.setClearColor(0x000000, 0);
        this.renderer.domElement.style.position = 'fixed';
        this.renderer.domElement.style.top = '0';
        this.renderer.domElement.style.left = '0';
        this.renderer.domElement.style.zIndex = '2';

        document.getElementById('threejs-container').appendChild(this.renderer.domElement);

        this.crearFlecha3D();
        this.configurarLuces();

        window.addEventListener('resize', this.onWindowResize.bind(this));
      }

      crearFlecha3D() {
        const arrowGroup = new THREE.Group();

        const coneGeometry = new THREE.ConeGeometry(0.2, 0.8, 8);
        const coneMaterial = new THREE.MeshPhongMaterial({
          color: 0x4CAF50,
          transparent: true,
          opacity: 0.9
        });
        const cone = new THREE.Mesh(coneGeometry, coneMaterial);
        cone.position.y = 0.4;

        const cylinderGeometry = new THREE.CylinderGeometry(0.08, 0.08, 0.4, 8);
        const cylinderMaterial = new THREE.MeshPhongMaterial({
          color: 0x3366FF
        });
        const cylinder = new THREE.Mesh(cylinderGeometry, cylinderMaterial);
        cylinder.position.y = -0.2;

        arrowGroup.add(cone);
        arrowGroup.add(cylinder);

        arrowGroup.position.set(0, 0, -2);
        arrowGroup.scale.set(2, 2, 2);

        this.arrow = arrowGroup;
        this.scene.add(this.arrow);

        console.log('‚úÖ Flecha 3D creada');
      }

      configurarLuces() {
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        this.scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 5, 5);
        this.scene.add(directionalLight);
      }

      async iniciarCamara() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: 'environment',
              width: { ideal: 1280 },
              height: { ideal: 720 }
            },
            audio: false
          });

          const video = document.getElementById('camera-video');
          video.srcObject = stream;

          await new Promise((resolve) => {
            video.onloadedmetadata = () => {
              video.play();
              resolve();
            };
          });

          console.log('‚úÖ C√°mara iniciada correctamente');

        } catch (error) {
          console.error('‚ùå Error de c√°mara:', error);
          throw new Error('No se pudo acceder a la c√°mara: ' + error.message);
        }
      }

      iniciarGPS() {
        if (!navigator.geolocation) {
          this.mostrarError('Geolocalizaci√≥n no soportada');
          return;
        }

        console.log('üåç Iniciando GPS con alta precisi√≥n...');

        let isFirstPosition = true;
        let navigationRegistered = false;

        this.watchId = navigator.geolocation.watchPosition(
          (position) => {
            if (isFirstPosition && !navigationRegistered) {
              const smoothed = this.gpsFilter.getSmoothedPosition();
              if (smoothed) {
                this.startNavigationTracking(smoothed.lat, smoothed.lon);
                navigationRegistered = true;
                isFirstPosition = false;
                console.log('üìç Navegaci√≥n iniciada y registrada en backend');
              }
            }

            this.actualizarPosicionUsuario(position);
          },
          (error) => this.manejarErrorGPS(error),
          {
            enableHighAccuracy: true,
            timeout: 30000,
            maximumAge: 0
          }
        );
      }

      async iniciarOrientacion() {
        const permissionGranted = await requestOrientationPermissionIfNeeded();
        if (!permissionGranted) {
          this.mostrarError('Se necesitan permisos de orientaci√≥n para la br√∫jula');
          return;
        }

        installDeviceOrientationListener();
        console.log('üß≠ Sensores de orientaci√≥n iniciados');

        setInterval(() => {
          this.actualizarOrientacion();
        }, 100);
      }

      actualizarOrientacion() {
        const heading = getCurrentHeading();
        if (heading !== null) {
          this.currentHeading = heading;
          this.actualizarDireccionCompas();
          this.actualizarFlecha();
        }
      }

      actualizarDireccionCompas() {
        if (!this.compassDirection) return;

        const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
        const index = Math.round(this.currentHeading / 45) % 8;
        this.compassDirection.textContent = directions[index];
      }

      actualizarPosicionUsuario(position) {
        this.userPosition = position;
        const rawLat = position.coords.latitude;
        const rawLon = position.coords.longitude;
        const accuracy = position.coords.accuracy;

        const filtered = this.gpsFilter.addPosition(rawLat, rawLon, accuracy);
        const smoothed = this.gpsFilter.getSmoothedPosition();

        const userLat = smoothed ? smoothed.lat : filtered.lat;
        const userLon = smoothed ? smoothed.lon : filtered.lon;

        this.updateNavigationDistance(userLat, userLon);

        this.actualizarCalidadGPS(accuracy);

        if (this.destino) {
          this.currentDistance = this.calcularDistancia(userLat, userLon, this.destino.lat, this.destino.lon);
          this.targetBearing = this.calcularRumbo(userLat, userLon, this.destino.lat, this.destino.lon);

          this.actualizarInterfaz(this.currentDistance, this.targetBearing, accuracy);
          this.actualizarFlecha();

          const arrivalRadius = Math.max(15, accuracy * 1.5);

          if (this.currentDistance <= arrivalRadius) {
            this.llegadaDestino();
          }
        }

        console.log(`üìç GPS - Raw: ${rawLat.toFixed(7)}, ${rawLon.toFixed(7)} | Filtered: ${userLat.toFixed(7)}, ${userLon.toFixed(7)} | Accuracy: ${accuracy.toFixed(1)}m`);
      }

      actualizarCalidadGPS(accuracy) {
        if (!this.gpsQualityText) return;

        let qualityText = '';
        let qualityClass = '';

        if (accuracy < 5) {
          qualityText = 'Excelente';
          qualityClass = 'quality-excellent';
        } else if (accuracy < 10) {
          qualityText = 'Bueno';
          qualityClass = 'quality-good';
        } else if (accuracy < 20) {
          qualityText = 'Regular';
          qualityClass = 'quality-fair';
        } else {
          qualityText = 'Bajo';
          qualityClass = 'quality-poor';
        }

        this.gpsQualityText.innerHTML = `GPS: <span class="${qualityClass}">${qualityText}</span> (¬±${accuracy.toFixed(1)}m)`;
      }

      calcularDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const œÜ1 = lat1 * Math.PI / 180;
        const œÜ2 = lat2 * Math.PI / 180;
        const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
        const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

        const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
          Math.cos(œÜ1) * Math.cos(œÜ2) *
          Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        return R * c;
      }

      calcularRumbo(lat1, lon1, lat2, lon2) {
        const œÜ1 = lat1 * Math.PI / 180;
        const œÜ2 = lat2 * Math.PI / 180;
        const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

        const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
        const x = Math.cos(œÜ1) * Math.sin(œÜ2) -
          Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª);
        const Œ∏ = Math.atan2(y, x);

        return (Œ∏ * 180 / Math.PI + 360) % 360;
      }

      actualizarInterfaz(distancia, rumbo, accuracy) {
        let distanciaTexto;
        if (distancia < 1000) {
          distanciaTexto = `${Math.round(distancia)} m`;
        } else {
          distanciaTexto = `${(distancia / 1000).toFixed(1)} km`;
        }

        const arrivalRadius = Math.max(15, accuracy * 1.5);
        let statusIcon = 'üìç';
        let statusText = '';

        if (distancia <= arrivalRadius * 2 && distancia > arrivalRadius) {
          statusIcon = 'üéØ';
          statusText = '<br><span style="color: orange; font-weight: bold;">¬°Muy cerca! Sigue avanzando</span>';
        } else if (distancia <= arrivalRadius) {
          statusIcon = '‚úÖ';
          statusText = '<br><span style="color: #4CAF50; font-weight: bold;">¬°Llegaste!</span>';
        }

        this.actualizarEstado(`
          ${statusIcon} <b>${this.destino.name}</b><br>
          ${distanciaTexto} ¬∑ ${Math.round(rumbo)}¬∞<br>
          <small>Precisi√≥n GPS: ¬±${Math.round(accuracy)}m</small>
          ${statusText}
        `);

        if (this.debugDiv) {
          const smoothed = this.gpsFilter.getSmoothedPosition();
          this.debugDiv.innerHTML = `
            Posici√≥n: ${smoothed ? smoothed.lat.toFixed(7) : 'N/A'}, ${smoothed ? smoothed.lon.toFixed(7) : 'N/A'}<br>
            Destino: ${this.destino.lat.toFixed(7)}, ${this.destino.lon.toFixed(7)}<br>
            Distancia: ${Math.round(distancia)}m | Rumbo: ${Math.round(rumbo)}¬∞<br>
            Heading: ${Math.round(this.currentHeading)}¬∞ | Muestras GPS: ${this.gpsFilter.positions.length}<br>
            Recorrido: ${Math.round(this.totalDistanceTraveled)}m | Radio llegada: ${Math.round(arrivalRadius)}m
          `;
        }
      }

      actualizarFlecha() {
        if (!this.arrow || this.targetBearing === undefined || this.currentHeading === undefined) {
          return;
        }

        let relativeBearing = this.targetBearing - this.currentHeading;

        if (relativeBearing > 180) relativeBearing -= 360;
        if (relativeBearing < -180) relativeBearing += 360;

        const rotationY = THREE.MathUtils.degToRad(relativeBearing);
        this.arrow.rotation.y = rotationY;

        this.actualizarColorFlecha(Math.abs(relativeBearing));
      }

      actualizarColorFlecha(angleDiff) {
        if (!this.arrow) return;

        const cone = this.arrow.children[0];
        const cylinder = this.arrow.children[1];

        let color;
        if (angleDiff < 15) {
          color = 0x4CAF50;
        } else if (angleDiff < 45) {
          color = 0xFF9800;
        } else {
          color = 0xF44336;
        }

        cone.material.color.setHex(color);
        cylinder.material.color.setHex(color);
      }

      calibrarBrujula() {
        this.actualizarEstado('Gira el dispositivo en forma de 8 para calibrar');
        setTimeout(() => {
          this.actualizarEstado('Br√∫jula calibrada. Apunta la flecha verde hacia el destino.');
        }, 3000);
      }

      animate() {
        requestAnimationFrame(this.animate.bind(this));

        if (this.renderer && this.scene && this.camera) {
          this.renderer.render(this.scene, this.camera);
        }
      }

      onWindowResize() {
        if (this.camera && this.renderer) {
          this.camera.aspect = window.innerWidth / window.innerHeight;
          this.camera.updateProjectionMatrix();
          this.renderer.setSize(window.innerWidth, window.innerHeight);
        }
      }

      async llegadaDestino() {
        this.actualizarEstado(`
          <div style="color: #4CAF50; font-weight: bold;">
            ¬°HAS LLEGADO!<br>
            ${this.destino.name}
          </div>
        `);

        await this.completeNavigationTracking(true);

        if (this.watchId) {
          navigator.geolocation.clearWatch(this.watchId);
          this.watchId = null;
        }

        if (navigator.vibrate) {
          navigator.vibrate([300, 100, 300, 100, 300]);
        }
      }

      actualizarEstado(mensaje) {
        if (this.statusText) {
          this.statusText.innerHTML = mensaje;
        }
      }

      manejarErrorGPS(error) {
        let mensaje = 'Error GPS: ';
        switch (error.code) {
          case error.PERMISSION_DENIED:
            mensaje = 'Permiso de ubicaci√≥n denegado. Activa la ubicaci√≥n.';
            break;
          case error.POSITION_UNAVAILABLE:
            mensaje = 'Ubicaci√≥n no disponible. Verifica tu GPS.';
            break;
          case error.TIMEOUT:
            mensaje = 'Tiempo de espera agotado. Reintentando...';
            console.log('‚è±Ô∏è GPS timeout, continuando...');
            return;
          default:
            mensaje = 'Error de GPS: ' + error.message;
        }
        this.mostrarError(mensaje);
      }

      mostrarError(mensaje) {
        console.error('‚ùå Error:', mensaje);
        this.actualizarEstado(`<div style="color: #ff4444;">${mensaje}</div>`);
      }

      async cleanup() {
        if (this.navigationActive) {
          await this.completeNavigationTracking(false);
        }

        if (this.watchId) {
          navigator.geolocation.clearWatch(this.watchId);
          this.watchId = null;
        }
        if (this.renderer) {
          this.renderer.dispose();
        }
        const video = document.getElementById('camera-video');
        if (video.srcObject) {
          video.srcObject.getTracks().forEach(track => track.stop());
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      window.orientationAR = new OrientationAR();
    });

    window.addEventListener('beforeunload', () => {
      if (window.orientationAR) {
        window.orientationAR.cleanup();
      }
    });
  </script>
</body>

</html>